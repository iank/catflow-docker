version: "3.9"

services:
  app:
    stdin_open: true
    tty: true
    build: .
    image: heartexlabs/label-studio:latest
    restart: unless-stopped
    ports:
      - "127.0.0.1:8000:8000"
    depends_on:
      - db
    environment:
      - DJANGO_DB=default
      - POSTGRE_NAME=postgres
      - POSTGRE_USER=postgres
      - POSTGRE_PASSWORD=
      - POSTGRE_PORT=5432
      - POSTGRE_HOST=db
      - LABEL_STUDIO_HOST=${LABEL_STUDIO_HOST:-}
      - JSON_LOG=1
      - LABEL_STUDIO_DISABLE_SIGNUP_WITHOUT_LINK=true
        #      - LOG_LEVEL=INFO
    volumes:
      - /data/labelstudio/mydata:/label-studio/data:rw
    command: label-studio-uwsgi

  db:
    image: postgres:11.5
    hostname: db
    restart: unless-stopped
    environment:
      - POSTGRES_HOST_AUTH_METHOD=trust
    volumes:
      - /data/labelstudio/postgres-data:/var/lib/postgresql/data
      - /data/labelstudio/deploy/pgsql/certs:/var/lib/postgresql/certs:ro

  vectordb:
    image: ankane/pgvector
    hostname: vectordb
    restart: unless-stopped
    environment:
      - POSTGRES_HOST_AUTH_METHOD=trust
    ports:
      - "127.0.0.1:5433:5432"
    volumes:
      - /data/vectordb/postgres-data:/var/lib/postgresql/data

  inference:
    image: iank1/catflow_inference:v0.2.0
    restart: unless-stopped
    ports:
      - "127.0.0.1:5054:5054"
    environment:
      - YOLO_THRESHOLD=${YOLO_THRESHOLD}
      - YOLO_WEIGHTS=${YOLO_WEIGHTS}
    volumes:
      - ./uncertain_hummingbird_2281_best.pt:/app/uncertain_hummingbird_2281_best.pt


  rabbitmq:
    image: rabbitmq:latest
    restart: unless-stopped
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS}
    ports:
      - "127.0.0.1:5672:5672"
      - "10.76.22.10:5672:5672"

  ingest:
    image: iank1/catflow_ingest:v0.2.0
    restart: unless-stopped
    ports:
      - "127.0.0.1:5057:5057"
    depends_on:
      - rabbitmq
    environment:
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq:5672/
      - RABBITMQ_EXCHANGE=${CATFLOW_RABBITMQ_EXCHANGE}
      - AWS_ACCESS_KEY_ID=${CATFLOW_AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${CATFLOW_AWS_SECRET_ACCESS_KEY}
      - S3_ENDPOINT_URL=${CATFLOW_S3_ENDPOINT_URL}
      - AWS_BUCKETNAME=${CATFLOW_AWS_BUCKETNAME}

  videosplit:
    image: iank1/catflow_service_videosplit:v0.3.0
    restart: unless-stopped
    depends_on:
      - rabbitmq
    environment:
      - CATFLOW_AMQP_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq:5672/
      - CATFLOW_AMQP_EXCHANGE=${CATFLOW_RABBITMQ_EXCHANGE}
      - CATFLOW_AWS_ACCESS_KEY_ID=${CATFLOW_AWS_ACCESS_KEY_ID}
      - CATFLOW_AWS_SECRET_ACCESS_KEY=${CATFLOW_AWS_SECRET_ACCESS_KEY}
      - CATFLOW_S3_ENDPOINT_URL=${CATFLOW_S3_ENDPOINT_URL}
      - CATFLOW_AWS_BUCKET_NAME=${CATFLOW_AWS_BUCKETNAME}

  inference-svc:
    image: iank1/catflow_service_inference:v0.3.1
    restart: unless-stopped
    depends_on:
      - rabbitmq
    environment:
      - CATFLOW_AMQP_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq:5672/
      - CATFLOW_AMQP_EXCHANGE=${CATFLOW_RABBITMQ_EXCHANGE}
      - CATFLOW_AWS_ACCESS_KEY_ID=${CATFLOW_AWS_ACCESS_KEY_ID}
      - CATFLOW_AWS_SECRET_ACCESS_KEY=${CATFLOW_AWS_SECRET_ACCESS_KEY}
      - CATFLOW_S3_ENDPOINT_URL=${CATFLOW_S3_ENDPOINT_URL}
      - CATFLOW_AWS_BUCKET_NAME=${CATFLOW_AWS_BUCKETNAME}
      - CATFLOW_MODEL_NAME=${CATFLOW_MODEL_NAME}
      - CATFLOW_MODEL_THRESHOLD=${CATFLOW_MODEL_THRESHOLD}
    volumes:
      - ./uncertain_hummingbird_2281_best.pt:/app/uncertain_hummingbird_2281_best.pt

  filter:
    image: iank1/catflow_service_filter:v0.1.3
    restart: unless-stopped
    depends_on:
      - rabbitmq
      - vectordb
    environment:
      - CATFLOW_AMQP_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq:5672/
      - CATFLOW_AMQP_EXCHANGE=${CATFLOW_RABBITMQ_EXCHANGE}
      - CATFLOW_AWS_ACCESS_KEY_ID=${CATFLOW_AWS_ACCESS_KEY_ID}
      - CATFLOW_AWS_SECRET_ACCESS_KEY=${CATFLOW_AWS_SECRET_ACCESS_KEY}
      - CATFLOW_S3_ENDPOINT_URL=${CATFLOW_S3_ENDPOINT_URL}
      - CATFLOW_AWS_BUCKET_NAME=${CATFLOW_AWS_BUCKETNAME}
      - CATFLOW_PG_HOST=${CATFLOW_PG_HOST}
      - CATFLOW_PG_DBNAME=${CATFLOW_PG_DBNAME}
      - CATFLOW_PG_USER=${CATFLOW_PG_USER}
      - CATFLOW_PG_PASSWORD=${CATFLOW_PG_PASSWORD}
      - CATFLOW_PG_PORT=${CATFLOW_PG_PORT}
      - CATFLOW_VDB_THRESHOLD=${CATFLOW_VDB_THRESHOLD}

  taskcreator:
    image: iank1/catflow_service_taskcreator:v0.1.1
    restart: unless-stopped
    depends_on:
      - rabbitmq
      - app
    environment:
      - CATFLOW_AMQP_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq:5672/
      - CATFLOW_AMQP_EXCHANGE=${CATFLOW_RABBITMQ_EXCHANGE}
      - CATFLOW_AWS_ACCESS_KEY_ID=${CATFLOW_AWS_ACCESS_KEY_ID}
      - CATFLOW_AWS_SECRET_ACCESS_KEY=${CATFLOW_AWS_SECRET_ACCESS_KEY}
      - CATFLOW_S3_ENDPOINT_URL=${CATFLOW_S3_ENDPOINT_URL}
      - CATFLOW_AWS_BUCKET_NAME=${CATFLOW_AWS_BUCKETNAME}
      - CATFLOW_LS_BUCKET_NAME=${CATFLOW_LS_BUCKET_NAME}
      - CATFLOW_LS_BASE_URL=${CATFLOW_LS_BASE_URL}
      - CATFLOW_LS_PROJECT_ID=${CATFLOW_LS_PROJECT_ID}
      - CATFLOW_LS_AUTH_TOKEN=${CATFLOW_LS_AUTH_TOKEN}
